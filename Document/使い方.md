# 拡張スペキュラー 使い方

この拡張シェーダーは lilToon に「2層のスペキュラー」を追加します。各層は独立してマスク・ノイズ・カラー・強度・スムースネス・ノーマル強度を設定でき、強度/スムースネス/マスク/ノイズはテクスチャのチャンネル（R/G/B/A）を選択して使用できます。

---

## セットアップ

1. マテリアルにシェーダーを割り当てる
   - シェーダー: `dennoko_extension_specular/lilToon`（用途に応じて Cutout/Transparent/Lite などのバリアントも利用可能）
2. マテリアルを選択すると、インスペクターに「Custom Properties」→「Specular 1st / Specular 2nd」が表示されます。
3. それぞれのレイヤーで「有効化」をオンにし、必要なパラメーターを設定してください。

---

## パラメーター概要（各レイヤー共通）

- 有効化
  - そのレイヤーのスペキュラーを有効にします。

- Mask (R) + Channel
  - スペキュラーの適用範囲マスクです。テクスチャの任意チャンネル（R/G/B/A）を使用できます。
  - マスクは白い部分ほど適用、黒い部分は無効化されます。
  - Tiling/OffsetでUVの繰り返しやオフセットが可能です。

- Noise (R) + Channel
  - スペキュラーの強度に乗算するノイズです。任意チャンネル（R/G/B/A）を使用できます。
  - マスクと同様に Tiling/Offset を設定できます。

- カラーマップ使用 / Color Map (RGB) / 色
  - カラーマップ使用: ON のとき Color Map (RGB) テクスチャでスペキュラーカラーを決めます。
  - OFF のときは「色」のカラーピッカー値が適用されます。

- 強度マップ使用 / Intensity または Intensity Map (R) + Channel
  - 強度マップ使用: ON のとき Intensity Map の任意チャンネル（R/G/B/A）を強度に掛け合わせます。
  - OFF のときはスライダー「強度」の値（0〜8）を使用します。

- スムースネスマップ使用 / Smoothness または Smoothness Map (R) + Channel
  - スムースネスマップ使用: ON のとき Smoothness Map の任意チャンネル（R/G/B/A）をスムースネスに掛け合わせます。
  - OFF のときはスライダー「スムースネス」の値（0〜1）を使用します。
  - スムースネスが高いほどハイライトは鋭く、小さいほど広がります。

- ノーマル強度（0〜3）
  - レイヤーごとの法線の効き具合を調整します。
  - 0: ベース法線（ノーマルマップ無効）
  - 1: 通常のノーマルマップ（そのまま）
  - 1〜3: 法線の傾きを強くします。

---

## 基本的な使い方の例

- 例1: ベースの広いハイライト + 先鋭な上塗り
  1. Specular 1st を有効化し、やや低めのスムースネス＋広めの強度でベースのハイライトを作る。
  2. Specular 2nd を有効化し、スムースネスを高め、ノーマル強度も 1〜2 程度でエッジを強調。
  3. 2nd の Mask/Noise を使って特定のパーツだけに強いハイライトを追加。

- 例2: テクスチャ1枚を複数チャンネルで活用
  1. Intensity/Smoothness/Mask/Noise を同じテクスチャにまとめて保存（R=Mask, G=Noise, B=Intensity, A=Smoothness 等）。
  2. 各プロパティの Channel で割り当てるチャンネルを選択して参照。
  ※テクスチャ枚数の節約に有効です。

---

## ヒント / 注意点

- マスクとノイズは乗算され、さらに「有効化」がオンのときだけそのレイヤーが寄与します。
- Color Map は RGB を使用し、Intensity/Smoothness/Mask/Noise はスカラーとして R/G/B/A のいずれか1チャネルを参照します。
- ノーマル強度を 1 より大きくするとハイライトの立ち上がりが強調されます。強すぎる場合は 1 付近まで戻してください。
- 影エリアではライトの影響によりスペキュラーが抑制されることがあります。マスク/ノイズの確認は明るい環境で行うと分かりやすいです。
- Tiling/Offsetは Mask/Noise/各マップごとに個別に設定できます。

---

## トラブルシューティング

- 何も変化が出ない
  - レイヤーの「有効化」がオンか確認。
  - Mask と Noise の乗算結果（overall）が黒に近いと寄与がゼロになります。テクスチャやチャンネル選択を見直してください。

- 思ったチャンネルにならない
  - Channel のポップアップで R/G/B/A を選択し直してください。同じテクスチャでもプロパティごとに異なるチャンネルを指定できます。

- ハイライトが広がりすぎ / 鋭すぎ
  - スムースネスを下げる（広がる）／上げる（鋭くなる）で調整。
  - ノーマル強度も合わせて微調整すると自然になります。

---

## 技術メモ（参考）

- スペキュラーは各レイヤーで Blinn-Phong に近いモデルを使用し、最終的に加算されます。
- 強度/スムースネス/マスク/ノイズは、それぞれ指定したチャンネルの値を用いてスカラーとして扱われます。
- ノーマル強度は `N = normalize(lerp(Norig, Nmap, s))`（s=0..3 を clamp）で補間しています。

以上です。簡易的なベースから始めて、Mask/Noise/チャンネル選択を活用して細かい表現を積み上げてください。
